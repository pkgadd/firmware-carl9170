From bd3e83c8a4065c23c0f437b231e8d4c26f82e20a Mon Sep 17 00:00:00 2001
From: Christian Lamparter <chunkeey@googlemail.com>
Date: Fri, 23 Dec 2011 20:40:49 +0100
Subject: [PATCH 46/63] carl9170 firmware: remove debug tx/rx paths crud

Signed-off-by: Christian Lamparter <chunkeey@googlemail.com>
---
 carlfw/Kconfig          |   28 +---------------------------
 carlfw/include/config.h |    5 -----
 carlfw/src/hostif.c     |    5 -----
 carlfw/src/wlan.c       |   17 ++---------------
 4 files changed, 3 insertions(+), 52 deletions(-)

--- a/carlfw/Kconfig
+++ b/carlfw/Kconfig
@@ -198,35 +198,9 @@ config CARL9170FW_UART_CLOCK_40M
 
 endchoice
 
-
-choice
-	prompt "TX / RX Path"
-
-	default CARL9170FW_NORMAL_TX_RX
-
-	config CARL9170FW_NORMAL_TX_RX
-		bool
-		prompt "Normal WLAN TX/RX routines"
-
-	config CARL9170FW_LOOPBACK
-		bool
-		depends on CARL9170FW_BROKEN_FEATURES
-		prompt "TX->(tx feedback)->RX loopback"
-		---help---
-		 Useful carlu testcase.
-
-	config CARL9170FW_DISCARD
-		bool
-		depends on CARL9170FW_BROKEN_FEATURES
-		prompt "TX->(tx feedback)"
-		---help---
-		 Useful carlu testcase
-
-endchoice
-
 config CARL9170FW_UNUSABLE
 	def_bool y
-	depends on CARL9170FW_BROKEN || CARL9170FW_LOOPBACK
+	depends on CARL9170FW_BROKEN || CARL9170FW_DEBUG
 
 config CARL9170FW_USB_MODESWITCH
 	def_bool n
--- a/carlfw/include/config.h
+++ b/carlfw/include/config.h
@@ -54,11 +54,6 @@
 
 #define CONFIG_CARL9170FW_BACK_REQS_NUM	4
 
-#if ((defined CONFIG_CARL9170FW_DEBUG) ||	\
-	(defined CONFIG_CARL9170FW_LOOPBACK))
-#define CARL9170FW_UNUSABLE	y
-#endif
-
 static inline void __config_check(void)
 {
 	BUILD_BUG_ON(!CARL9170_TX_STATUS_NUM);
--- a/carlfw/src/hostif.c
+++ b/carlfw/src/hostif.c
@@ -96,13 +96,8 @@ static void handle_upload(void)
 			fw.usb.int_desc = desc;
 			fw.usb.int_desc_available = 1;
 		} else {
-#ifdef CONFIG_CARL9170FW_LOOPBACK
-			dma_reclaim(&fw.pta.down_queue, desc);
-			down_trigger();
-#else
 			dma_reclaim(&fw.wlan.rx_queue, desc);
 			wlan_trigger(AR9170_DMA_TRIGGER_RXQ);
-#endif /* CONFIG_CARL9170FW_LOOPBACK */
 		}
 	}
 
--- a/carlfw/src/wlan.c
+++ b/carlfw/src/wlan.c
@@ -292,25 +292,12 @@ static void __wlan_tx(struct dma_desc *d
 
 	wlan_tx_ampdu(super);
 
-#if (defined CONFIG_CARL9170FW_LOOPBACK) || (defined CONFIG_CARL9170FW_DISCARD)
-	wlan_tx_complete(super, true);
-	unhide_super(desc);
-# ifdef CONFIG_CARL9170FW_LOOPBACK
-	dma_put(&fw.pta.up_queue, desc);
-	up_trigger();
-# elif CONFIG_CARL9170FW_DISCARD
-	dma_reclaim(&fw.pta.down_queue, desc);
-	down_trigger();
-# endif
-#else /* CONFIG_CARL9170FW_LOOPBACK */
-
-# ifdef CONFIG_CARL9170FW_DEBUG
+#ifdef CONFIG_CARL9170FW_DEBUG
 	BUG_ON(fw.phy.psm.state != CARL9170_PSM_WAKE);
-# endif /* CONFIG_CARL9170FW_DEBUG */
+#endif /* CONFIG_CARL9170FW_DEBUG */
 
 	/* insert desc into the right queue */
 	dma_put(&fw.wlan.tx_queue[super->s.queue], desc);
-#endif /* CONFIG_CARL9170FW_LOOPBACK */
 }
 
 static void wlan_assign_seq(struct ieee80211_hdr *hdr, unsigned int vif)
